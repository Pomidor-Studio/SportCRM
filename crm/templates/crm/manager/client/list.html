{% extends "crm/base.html" %}

{% load bootstrap4 html_helper %}

{% block nav %}
{% endblock nav %}

{% block content %}

  <script language="javascript">
    $(function () {
      $("#clear-search").click(function (e) {
        $('#' + $(this).data('search-id')).val('');
        $(this).parents('form').submit();
      });
    });
  </script>


  <div class="ml-4 mt-4 mr-4 container-fluid">
    <legend class="border-bottom mb-2">Ученики</legend>
    <div style="background-color: #FFFFFF;" class="sticky-top">
      <div class="row">
        <div class="col-md-6">
          <form class="form-inline mb-2"
                action="{% url 'crm:manager:client:list' %}" method="GET">
            {% ifhasperm 'client.add' user %}
          <a name="add-new"
             href="{% url 'crm:manager:client:new' %}"
             class="btn btn-sm btn-info"
          >
            Добавить ученика
          </a>
          {% endifhasperm %}
            <div class="input-group  ml-2 w-50">
              <input
                id="{{ filter.form.name.id_for_label }}"
                name="{{ filter.form.name.name }}"
                placeholder="{{ filter.form.name.label }}"
                value="{{ filter.form.name.data|default_if_none:'' }}"
                type="search"
                class="form-control form-control-sm"
              >
              <div class="input-group-append">
                <a
                  href="#"
                  id="clear-search"
                  class="btn btn-sm btn-outline-danger"
                  data-search-id="{{ filter.form.name.id_for_label }}"
                >
                  <i class="fas fa-times"></i>
                </a>
              </div>
            </div>

            <input type="submit"
                   value="Поиск" class=" ml-2 btn btn-sm btn-success"/>
          </form>
        </div>
      </div>
    </div>


    <table class="table table-sm table-bordered">
      <thead>
      <tr>
        <th scope="col">Общение</th>
        <th scope="col">Инфо</th>
        <th scope="col">Абонемент</th>
        <th scope="col">Баланс</th>
      </tr>
      </thead>
      <tbody>
      {% for client in clients %}
        <tr>
          <td>
            <div>
              {% if client.phone_number %}
                <a class="btn btn-sm btn-outline-info" href="tel:{{ client.phone_number }}">
                  Позвонить
                </a>
              {% endif %}
            </div>
            <div>
              {% if client.vk_user_id %}
                <a class="btn btn-sm btn-outline-info" target="_blank" href="https://vk.com/gim176552308?sel={{ client.vk_user_id }}">
                  Написать в VK
                </a>
              {% endif %}
            </div>
            <div>
              {% if client.email_address %}
                <a class="btn btn-sm btn-outline-info" href="mailto:{{ client.email_address }}">
                  Написать на почту
                </a>
              {% endif %}
            </div>
          </td>
          <td>
          {% ifhasperm 'client' user %}
            <a href="{% url 'crm:manager:client:detail' client.id %}">
              <div class="font-weight-bold">{{ client.name }}</div>
              <div>{{ client.phone_number }}</div>
              <div>{{ client.email_address }}</div>
            </a>
            {% endifhasperm %}
          </td>
          <td>
            {% if client.last_sub %}
              <div class="font-weight-bold">
                {% if client.last_sub.is_expiring %}
                  <i title="Абонемент скоро заканчивается"
                     class="fas fa-exclamation-circle"></i>
                {% endif %}
                {{ client.last_sub.subscription.name }}
              </div>
              <div>Действует
                до {{ client.last_sub.end_date|date:'d N Y' }}</div>
              <div>Осталось {{ client.last_sub.visits_left }} посещений</div>
              {% ifhasperm 'is_manager' user %}
              <a class="btn btn-sm btn-outline-info"
                 href="{% url 'crm:manager:client:subscription:extend' client.last_sub.id %}">Продлить</a>
              {% endifhasperm %}
            {% endif %}
          </td>
          <td>
            {{ client.balance }} ₽
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>

    {% bootstrap_pagination page_obj extra=filter.data.urlencode %}
  </div>

{% endblock content %}
