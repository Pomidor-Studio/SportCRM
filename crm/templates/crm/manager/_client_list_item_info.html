{% load html_helper humanize %}

<td>
  <div class="balance d-md-none">
    <span class="{% if client.balance < 0 %}orange{% else %}green{% endif %}">
      {{ client.balance|floatformat:"-2"|intcomma }}&nbsp;₽
    </span>
  </div>
  {% if client.deleted %}
    {{ client.name }}
  {% else %}
    {% ifhasperm 'client_subscription.edit' user %}
      <a href=" {% url 'crm:manager:client:detail' client.id %}"
         class="fio_name">{{ client.name }}</a>
    {% else %}
      {{ client.name }}
    {% endifhasperm %}
  {% endif %}
  <div class="d-none d-md-block">
    <small>{{ client.phone_number }}</small>
  </div>
  <div class="d-md-none">
    {% if client.get_active_sub|length == 1 %}
      {% with client.get_active_sub.first as sub %}
        {{ sub.subscription.name }}
        <br/>
        <small>Осталось посещений: {{ sub.visits_left }}</small>
      {% endwith %}
    {% elif client.get_active_sub|length > 1 %}
      <form class="subscription_select">
        {% for sub in client.get_active_sub %}
          <div class="form-check">
            <input class="form-check-input" type="radio" name="abonement"
                   id="abonement{{ sub.id }}" value="{{ sub.id }}"
                   checked="checked" data-subscription="{{ sub.id }}">
            <div class="form-check-input-div form-check-input-div-radio"></div>
            <label class="form-check-label" for="abonement{{ sub.id }}">
              <small>{{ sub.subscription.name }}
                ({{ sub.visits_left }}/{{ sub.visits_on_by_time }})
              </small>
            </label>
          </div>
          {% if not forloop.last %}
            <div class="greyline"></div>
          {% endif %}
        {% endfor %}
      </form>
    {% elif client.last_sub %}
      {{ client.last_sub.subscription.name }}
      <br/>
      <small>Абонемент
        закончился {{ client.last_sub.end_date|date:"SHORT_DATE_FORMAT" }} </small>
    {% else %}
      Без абонемента
    {% endif %}
  </div>
</td>
