{% extends "crm/base.html" %}

{% load bootstrap4 %}

{% block extrahead %}
  <script
    src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/3/jquery.inputmask.bundle.js"
  ></script>
  <script
    src="https://unpkg.com/libphonenumber-js@1.7.10/bundle/libphonenumber-max.js"
  ></script>
  <script type="text/javascript">
    $(function () {
      const phoneAYT = new libphonenumber.AsYouType('RU');
      let oldData = $('[data-phone]').val();

      $('[data-phone]').on('input', function (e) {
        const data = $(this).val().trim();
        const phone = phoneAYT.input(data);
        const number = phoneAYT.getNumber();

        if (number === undefined || number.isValid()) {
          e.currentTarget.setCustomValidity('');
        } else {
          e.currentTarget.setCustomValidity('Неправильный номер');
        }
        if (oldData !== phone) {
          $(e.currentTarget).val(phone);
          oldData = phone;
        }
        phoneAYT.reset();
      });

      $('[data-name-edit]').on('input', function () {
        let data = $(this).val().trim();
        let items = data.split(' ');
        let result = items.splice(0, 1);
        result.push(items.join(' '));
        $('#' + '{{ form.user.first_name.id_for_label }}').val(result[0]);
        $('#' + '{{ form.user.last_name.id_for_label }}').val(result[1]);
      });

      {% if user.has_vk_auth %}
        getUserPicture('{{ user.vk_id }}');
      {% endif %}
    });

    function getUserPicture(id) {
      let access_token = '6cd5df431f32f7b9f67a44baf2e0859265b290fc6e892d26b39fed3b961e72355dbea36fcc2d9a02dc4f4';
      $.ajax({
        url: 'https://api.vk.com/method/users.get',
        data: {
          user_ids: id,
          fields: "photo_200,domain",
          access_token: access_token,
          v: 5.63
        },
        dataType: 'jsonp',
        crossDomain: true,
        success: function (data) {
          $("#profile-pic").attr("src", data.response[0].photo_200);
        }
      });
    }
  </script>
{% endblock %}

{% block content %}
  <div class="content-section ml-4 mt-4 w-50">
    <legend class="border-bottom mb-2">Настройка профиля</legend>
    {% if user.has_vk_auth %}
      <div class="row mb-3">
        <div class="col-3">
          <a href="{{ user.vk_link|safe }}" target="_blank">
            <img id="profile-pic" class="rounded-circle"/>
          </a>
        </div>
        <div class="col">
          <a href="{{ user.vk_link|safe }}" target="_blank">
            <i class="fab fa-vk"></i>&nbsp;{{ user.vk_link|safe }}
          </a>
        </div>
      </div>
    {% endif %}
    <form method="post">

      {% csrf_token %}
      {% bootstrap_field form.user.username show_help=False %}
      {% bootstrap_field form.user.fullname %}
      {% bootstrap_field form.user.first_name %}
      {% bootstrap_field form.user.last_name %}
      {% bootstrap_field form.user.email %}
      {% bootstrap_form form.detail show_help=False %}

      <input type="submit" value="Сохранить" class="btn btn-primary">

      {% if user.has_usable_password %}
        <a
          href="{% url 'crm:accounts:password-change' %}"
          class="btn btn-outline-danger"
        >Сменить пароль</a>
      {% endif %}
      <a
        href="{% url 'crm:accounts:password-reset-confirm' %}"
        class="btn btn-outline-danger"
      >Сбросить пароль</a>

      {% if not user.has_vk_auth %}
      <a
        class="btn btn-primary"
        href="{% url "social:begin" "vk-oauth2" %}"
        role="button"
      >
        Привязать ВК <i class="fab fa-vk"></i>
      </a>
      {% endif %}

    </form>
  </div>
{% endblock %}
